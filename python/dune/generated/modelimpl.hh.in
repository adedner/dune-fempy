#include <dune/fempy/pybind11/pybind11.h>

#include <dune/fem/gridpart/leafgridpart.hh>
#include <dune/fem/gridpart/adaptiveleafgridpart.hh>

// #include <dune/fempy/gridfunction.hh>

#include <dune/fem/schemes/diffusionmodel.hh>
#include "ModelTmp.hh"

typedef #GRIDPARTCHOICE GridPart;
namespace ModelTmp
{
  struct PyModel : public Model< GridPart#PYTEMPLATE >
  {
    typedef PyModel This;
    typedef DiffusionModelWrapper<This> Wrapper;
    typedef typename Wrapper::Base BaseModel;
    PyModel()
    {}
    ~PyModel()
    {
      std::cout << "In PyModel destructor" << std::endl;
    }
    int getDimRange()
    {
      return #DIMRANGE;
    }
  };

  typedef DiffusionModelWrapper<PyModel> ModelWrapperType;
  std::shared_ptr<ModelWrapperType> wrap(std::shared_ptr<PyModel> &model)
  {
    return make_shared<ModelWrapperType>(model);
  }

  int getDimRange()
  {
    return #DIMRANGE;
  }
}

PYBIND11_PLUGIN(#MODELNAME) {
  namespace py = pybind11;
  using namespace ModelTmp;
  py::module m("model", "pybind model plugin");
  typedef typename ModelWrapperType::Base ModelBase;
  py::class_< PyModel >( m, "get" )
  .def( "getDimRange", &PyModel::getDimRange )
  .def( "wrap", &wrap )
  #PYSETCOEFFICIENT
  ;
  py::class_< ModelBase>( m, "ModelBase" );
  py::class_< std::shared_ptr<ModelWrapperType> >( m, "ModelWrapper", py::base<ModelBase>() )
  .def("getDimRange", &getDimRange);
}
